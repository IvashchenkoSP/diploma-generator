package com.diplomagenerator.service;

import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.PDPage;
import org.apache.pdfbox.pdmodel.PDPageContentStream;
import org.apache.pdfbox.pdmodel.font.PDType1Font;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

@Service
public class DiplomaService {

    private final String uploadDir = "uploads/";
    private final String outputDir = "output/";

    public DiplomaService() {
        createDirectories();
    }

    private void createDirectories() {
        try {
            Files.createDirectories(Paths.get(uploadDir));
            Files.createDirectories(Paths.get(outputDir));
            System.out.println("‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã");
        } catch (IOException e) {
            throw new RuntimeException("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏", e);
        }
    }

    public String saveUploadedTemplate(MultipartFile file) throws IOException {
        if (file.isEmpty()) {
            throw new IllegalArgumentException("–§–∞–π–ª –ø—É—Å—Ç–æ–π");
        }
        
        if (!file.getOriginalFilename().toLowerCase().endsWith(".pdf")) {
            throw new IllegalArgumentException("–¢–æ–ª—å–∫–æ PDF —Ñ–∞–π–ª—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è");
        }
        
        String fileName = UUID.randomUUID() + "_" + file.getOriginalFilename();
        Path filePath = Paths.get(uploadDir + fileName);
        Files.write(filePath, file.getBytes());
        System.out.println("‚úÖ –®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω: " + filePath);
        return filePath.toString();
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–ø–ª–æ–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞
    public String generateDiplomaFromTemplate(String templatePath, String fullName, 
                                            float posX, float posY, float fontSize) throws IOException {
        System.out.println("üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑ —à–∞–±–ª–æ–Ω–∞: " + templatePath);
        
        if (!Files.exists(Paths.get(templatePath))) {
            throw new IOException("–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω: " + templatePath);
        }

        String outputFileName = UUID.randomUUID() + "_diploma.pdf";
        String outputPath = outputDir + outputFileName;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω PDF
        try (PDDocument document = PDDocument.load(new File(templatePath))) {
            PDPage page = document.getPage(0);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ–≤–µ—Ä—Ö —à–∞–±–ª–æ–Ω–∞
            try (PDPageContentStream contentStream = new PDPageContentStream(
                    document, page, PDPageContentStream.AppendMode.APPEND, true, true)) {
                
                String latinName = convertToLatin(fullName);
                contentStream.setFont(PDType1Font.HELVETICA_BOLD, fontSize);
                contentStream.beginText();
                contentStream.newLineAtOffset(posX, posY);
                contentStream.showText(latinName);
                contentStream.endText();
            }

            document.save(outputPath);
            System.out.println("‚úÖ –î–∏–ø–ª–æ–º –∏–∑ —à–∞–±–ª–æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: " + outputPath);
        }

        return outputPath;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –¥–∏–ø–ª–æ–º–∞ (–±–µ–∑ —à–∞–±–ª–æ–Ω–∞)
    public String generateSimpleDiploma(String fullName, float posX, float posY, float fontSize) throws IOException {
        System.out.println("üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –¥–∏–ø–ª–æ–º–∞");
        
        String outputFileName = UUID.randomUUID() + "_diploma.pdf";
        String outputPath = outputDir + outputFileName;

        try (PDDocument document = new PDDocument()) {
            PDPage page = new PDPage();
            document.addPage(page);

            try (PDPageContentStream contentStream = new PDPageContentStream(document, page)) {
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                contentStream.setFont(PDType1Font.HELVETICA_BOLD, 24);
                contentStream.beginText();
                contentStream.newLineAtOffset(100, 700);
                contentStream.showText("DIPLOMA");
                contentStream.endText();

                // –§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                String latinName = convertToLatin(fullName);
                contentStream.setFont(PDType1Font.HELVETICA_BOLD, fontSize);
                contentStream.beginText();
                contentStream.newLineAtOffset(posX, posY);
                contentStream.showText(latinName);
                contentStream.endText();

                // –¢–µ–∫—Å—Ç –¥–∏–ø–ª–æ–º–∞
                contentStream.setFont(PDType1Font.HELVETICA, 14);
                contentStream.beginText();
                contentStream.newLineAtOffset(100, 400);
                contentStream.showText("Awarded for successful completion");
                contentStream.endText();
                
                contentStream.beginText();
                contentStream.newLineAtOffset(100, 370);
                contentStream.showText("of the training course");
                contentStream.endText();

                // –î–∞—Ç–∞
                contentStream.setFont(PDType1Font.HELVETICA, 12);
                contentStream.beginText();
                contentStream.newLineAtOffset(100, 200);
                contentStream.showText("Date: " + java.time.LocalDate.now());
                contentStream.endText();
            }

            document.save(outputPath);
            System.out.println("‚úÖ –ü—Ä–æ—Å—Ç–æ–π –¥–∏–ø–ª–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω: " + outputPath);
        }

        return outputPath;
    }

    // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —à–∞–±–ª–æ–Ω–∞)
    public String generateDiploma(String templatePath, String fullName, float posX, float posY, float fontSize) throws IOException {
        if (templatePath != null && !templatePath.isEmpty() && Files.exists(Paths.get(templatePath))) {
            return generateDiplomaFromTemplate(templatePath, fullName, posX, posY, fontSize);
        } else {
            return generateSimpleDiploma(fullName, posX, posY, fontSize);
        }
    }

    // –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ –ª–∞—Ç–∏–Ω–∏—Ü—É
    private String convertToLatin(String text) {
        if (text == null || text.trim().isEmpty()) {
            return "Student";
        }
        
        // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ —Ä—É—Å—Å–∫–∏—Ö –∏–º–µ–Ω –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏
        return text.replace("–ò–≤–∞–Ω–æ–≤", "Ivanov")
                  .replace("–ü–µ—Ç—Ä–æ–≤", "Petrov")
                  .replace("–°–∏–¥–æ—Ä–æ–≤", "Sidorov")
                  .replace("–ò–≤–∞–Ω", "Ivan")
                  .replace("–ü–µ—Ç—Ä", "Peter")
                  .replace("–ê–ª–µ–∫—Å–µ–π", "Alexey")
                  .replace("–°–µ—Ä–≥–µ–π", "Sergey")
                  .replace("–ê–Ω–Ω–∞", "Anna")
                  .replace("–ú–∞—Ä–∏—è", "Maria")
                  .replace("–ï–ª–µ–Ω–∞", "Elena")
                  .replace("–û–ª—å–≥–∞", "Olga")
                  .replace("–ù–∞—Ç–∞–ª—å—è", "Natalia")
                  .replace("–î–º–∏—Ç—Ä–∏–π", "Dmitry")
                  .replace("–ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "Alexander")
                  .replace("–í–ª–∞–¥–∏–º–∏—Ä", "Vladimir")
                  .replace("–ú–∏—Ö–∞–∏–ª", "Mikhail")
                  .replace("Test", "Test")
                  .replace("–¢–µ—Å—Ç", "Test");
    }

    // –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–ø–ª–æ–º–æ–≤
    public List<String> generateMultipleDiplomas(String templatePath, List<String> names, 
                                                float posX, float posY, float fontSize) throws IOException {
        System.out.println("üéØ –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è " + names.size() + " –¥–∏–ø–ª–æ–º–æ–≤");
        
        List<String> resultPaths = new ArrayList<>();
        
        for (String name : names) {
            if (!name.trim().isEmpty()) {
                String diplomaPath = generateDiploma(templatePath, name.trim(), posX, posY, fontSize);
                resultPaths.add(diplomaPath);
                System.out.println("‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–∏–ø–ª–æ–º –¥–ª—è: " + name);
            }
        }
        
        System.out.println("‚úÖ –í—Å–µ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: " + resultPaths.size() + " –¥–∏–ø–ª–æ–º–æ–≤");
        return resultPaths;
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ ZIP –∞—Ä—Ö–∏–≤–∞ —Å –¥–∏–ø–ª–æ–º–∞–º–∏
    public String createDiplomasZip(String templatePath, List<String> names, 
                                   float posX, float posY, float fontSize) throws IOException {
        System.out.println("üóúÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ ZIP –∞—Ä—Ö–∏–≤–∞ –¥–ª—è " + names.size() + " –¥–∏–ø–ª–æ–º–æ–≤");
        
        String zipFileName = UUID.randomUUID() + "_diplomas.zip";
        String zipPath = outputDir + zipFileName;
        
        List<String> diplomaPaths = generateMultipleDiplomas(templatePath, names, posX, posY, fontSize);
        
        try (FileOutputStream fos = new FileOutputStream(zipPath);
             ZipOutputStream zos = new ZipOutputStream(fos)) {
            
            for (int i = 0; i < diplomaPaths.size(); i++) {
                String diplomaPath = diplomaPaths.get(i);
                String name = names.get(i).trim();
                File diplomaFile = new File(diplomaPath);
                
                if (diplomaFile.exists()) {
                    String safeName = convertToLatin(name).replaceAll("[^a-zA-Z0-9]", "_");
                    ZipEntry zipEntry = new ZipEntry("diploma_" + safeName + ".pdf");
                    zos.putNextEntry(zipEntry);
                    Files.copy(diplomaFile.toPath(), zos);
                    zos.closeEntry();
                    diplomaFile.delete();
                    System.out.println("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤ ZIP: " + name);
                }
            }
        }
        
        System.out.println("‚úÖ ZIP –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: " + zipPath + " (" + new File(zipPath).length() + " bytes)");
        return zipPath;
    }

    public File getDiplomaFile(String filePath) {
        File file = new File(filePath);
        if (!file.exists()) {
            throw new RuntimeException("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " + filePath);
        }
        System.out.println("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞: " + filePath + " (" + file.length() + " bytes)");
        return file;
    }

    public boolean testPdfGeneration() {
        try {
            String testPath = generateSimpleDiploma("Test Student", 100, 500, 16);
            File testFile = new File(testPath);
            boolean exists = testFile.exists();
            if (exists) {
                testFile.delete();
            }
            System.out.println("üß™ –¢–µ—Å—Ç PDF: " + (exists ? "–£–°–ü–ï–•" : "–û–®–ò–ë–ö–ê"));
            return exists;
        } catch (Exception e) {
            System.out.println("‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ PDF: " + e.getMessage());
            return false;
        }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
    public List<String> getUploadedTemplates() {
        List<String> templates = new ArrayList<>();
        try {
            Files.list(Paths.get(uploadDir))
                 .filter(path -> path.toString().toLowerCase().endsWith(".pdf"))
                 .forEach(path -> templates.add(path.toString()));
            System.out.println("üìÅ –ù–∞–π–¥–µ–Ω–æ —à–∞–±–ª–æ–Ω–æ–≤: " + templates.size());
        } catch (IOException e) {
            System.out.println("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤: " + e.getMessage());
        }
        return templates;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–∑ –ø—É—Ç–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    public String getTemplateName(String templatePath) {
        if (templatePath == null || templatePath.isEmpty()) {
            return "";
        }
        return Paths.get(templatePath).getFileName().toString();
    }
}
